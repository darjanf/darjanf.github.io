<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-State Macro Intelligence Hub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #1a1a1a;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #666;
            font-size: 14px;
        }

        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            text-align: center;
        }

        .error-message h3 {
            color: #ff4444;
            margin-bottom: 10px;
        }

        .error-message p {
            color: #999;
            font-size: 13px;
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        /* Column 1: Left Sidebar - Area Navigation */
        .sidebar {
            width: 260px;
            background: #0f0f0f;
            border-right: 1px solid #1a1a1a;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #1a1a1a;
        }

        .sidebar-header h1 {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 11px;
            color: #666;
        }

        .area-nav {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .area-item {
            padding: 14px 16px;
            margin: 4px 0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #999;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid transparent;
        }

        .area-item:hover {
            background: #1a1a1a;
            color: #fff;
            border-color: #2a2a2a;
        }

        .area-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            color: #fff;
            border-color: rgba(102, 126, 234, 0.3);
            font-weight: 500;
        }

        .area-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .area-content {
            flex: 1;
        }

        .area-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .area-count {
            font-size: 11px;
            opacity: 0.6;
        }

        /* Right Content Area */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            padding: 60px 80px;
            overflow-y: auto;
            flex: 1;
        }

        .hero-section.hidden {
            display: none;
        }

        .hero-title {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            text-align: center;
        }

        .hero-card {
            background: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 30px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-card h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: #fff;
        }

        .hero-card p {
            font-size: 16px;
            line-height: 1.8;
            color: #b0b0b0;
            margin-bottom: 15px;
        }

        .hero-card strong {
            color: #fff;
        }

        .hero-cta-container {
            text-align: center;
            margin-top: 60px;
        }

        .hero-cta-container p {
            font-size: 16px;
            color: #999;
            margin-bottom: 30px;
        }

        .hero-cta {
            display: inline-block;
            padding: 16px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: #fff;
            text-decoration: none;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: transform 0.2s;
            border: none;
        }

        .hero-cta:hover {
            transform: translateY(-2px);
        }

        .story-box {
            margin-top: 25px;
            padding: 25px;
            background: rgba(102, 126, 234, 0.05);
            border-left: 3px solid #667eea;
            border-radius: 4px;
        }

        .warning-box {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 68, 68, 0.1);
            border-left: 3px solid #ff4444;
            border-radius: 4px;
        }

        /* 4-Column Workspace */
        .workspace {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .workspace.visible {
            display: flex;
        }

        /* Column 2: Area Synthesis */
        .area-synthesis {
            width: 380px;
            background: #0a0a0a;
            border-right: 1px solid #1a1a1a;
            overflow-y: auto;
            padding: 30px 25px;
        }

        .synthesis-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #fff;
        }

        .synthesis-content {
            font-size: 14px;
            line-height: 1.8;
            color: #b0b0b0;
        }

        .synthesis-content p {
            margin-bottom: 15px;
        }

        .synthesis-content strong {
            color: #fff;
        }

        .synthesis-section {
            margin-top: 25px;
            padding: 20px;
            background: #0f0f0f;
            border-radius: 8px;
            border: 1px solid #1a1a1a;
        }

        .synthesis-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .causality-chain {
            padding-left: 15px;
            border-left: 2px solid #667eea;
            margin: 15px 0;
        }

        .causality-chain p {
            margin: 8px 0;
            font-size: 13px;
            color: #b0b0b0;
        }

        .arrow {
            color: #667eea;
            margin: 0 5px;
        }

        /* Column 3: Cluster List */
        .cluster-list {
            width: 320px;
            background: #050505;
            border-right: 1px solid #1a1a1a;
            overflow-y: auto;
            padding: 20px 15px;
        }

        .cluster-list-header {
            padding: 10px 10px 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #1a1a1a;
        }

        .cluster-list-title {
            font-size: 13px;
            font-weight: 600;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cluster-item {
            padding: 16px 14px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #1a1a1a;
            background: #0a0a0a;
            transition: all 0.15s;
        }

        .cluster-item:hover {
            background: #0f0f0f;
            border-color: #2a2a2a;
            transform: translateX(2px);
        }

        .cluster-item.active {
            background: #0f0f0f;
            border-color: #4a9eff;
        }

        .cluster-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }

        .cluster-icon {
            font-size: 20px;
        }

        .cluster-title {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
            color: #e0e0e0;
            line-height: 1.3;
        }

        .cluster-themes {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
            padding-left: 30px;
            line-height: 1.5;
        }

        .cluster-meta {
            display: flex;
            gap: 10px;
            font-size: 11px;
            padding-left: 30px;
            margin-top: 8px;
        }

        .cluster-timeframe {
            color: #999;
        }

        .cluster-urgency {
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .urgency-ultra {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .urgency-high {
            background: rgba(255, 153, 68, 0.2);
            color: #ff9944;
        }

        .urgency-medium {
            background: rgba(255, 215, 68, 0.2);
            color: #ffd744;
        }

        .urgency-low {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        /* Column 4: Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
        }

        .chat-tabs {
            display: flex;
            background: #0a0a0a;
            border-bottom: 1px solid #1a1a1a;
            padding: 0 20px;
            gap: 4px;
            overflow-x: auto;
        }

        .chat-tab {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 13px;
            color: #666;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
        }

        .chat-tab:hover {
            color: #999;
        }

        .chat-tab.active {
            color: #4a9eff;
            border-bottom-color: #4a9eff;
        }

        .chat-tab-close {
            padding: 2px 6px;
            margin-left: 8px;
            border-radius: 4px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .chat-tab:hover .chat-tab-close {
            opacity: 0.6;
        }

        .chat-tab-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .new-chat-btn {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 13px;
            color: #4a9eff;
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .new-chat-btn:hover {
            background: rgba(74, 158, 255, 0.1);
        }

        .chat-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 14px;
            text-align: center;
            padding: 40px;
        }

        .chat-container {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            padding: 20px 30px;
            background: #0a0a0a;
            border-bottom: 1px solid #1a1a1a;
        }

        .chat-header h3 {
            font-size: 16px;
            color: #fff;
            margin-bottom: 4px;
        }

        .chat-header p {
            font-size: 12px;
            color: #666;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px;
            max-height: calc(100vh - 250px);
        }

        .message {
            margin-bottom: 24px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .avatar-claude {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .avatar-user {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .message-sender {
            font-size: 12px;
            font-weight: 600;
            color: #999;
        }

        .message-content {
            background: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 16px 20px;
            margin-left: 38px;
        }

        .message-content p {
            font-size: 14px;
            line-height: 1.7;
            color: #d0d0d0;
            margin-bottom: 10px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content strong {
            color: #fff;
        }

        .message-content h4 {
            font-size: 15px;
            color: #4a9eff;
            margin: 15px 0 10px 0;
        }

        .message-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 8px 0;
            color: #d0d0d0;
            line-height: 1.6;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .quick-action-btn {
            padding: 6px 12px;
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 6px;
            font-size: 12px;
            color: #4a9eff;
            cursor: pointer;
            transition: all 0.15s;
        }

        .quick-action-btn:hover {
            background: rgba(74, 158, 255, 0.15);
            border-color: #4a9eff;
        }

        .chat-input-area {
            padding: 20px 30px;
            background: #0a0a0a;
            border-top: 1px solid #1a1a1a;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 12px 16px;
            color: #fff;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #4a9eff;
            background: #0a0a0a;
        }

        .chat-input::placeholder {
            color: #555;
        }

        .send-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.15s;
        }

        .send-btn:hover {
            transform: translateY(-1px);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #1a1a1a;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2a2a2a;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Lade Retail-Analyse...</div>
    </div>

    <div class="main-container">
        <!-- Column 1: Left Sidebar - Area Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>K-State Intelligence</h1>
                <p>Dein Investment-Copilot</p>
            </div>

            <nav class="area-nav" id="areaNav">
                <!-- Dynamic content from retail_analysis.json -->
            </nav>
        </aside>

        <!-- Right Content Area -->
        <main class="content-area">
            <!-- Hero Section -->
            <section class="hero-section" id="heroSection">
                <h1 class="hero-title">Willkommen bei K-State</h1>

                <div class="hero-card">
                    <h2>Das Wichtigste zuerst</h2>
                    <p>Stell dir vor, du bist auf einer riesigen Party die schon seit 3 Jahren l√§uft.</p>
                    <p>Die Musik spielt laut (das ist der AI-Hype - jeder redet √ºber k√ºnstliche Intelligenz). Die Stimmung ist super. Aber die Getr√§nke waren die letzten 18 Monate ziemlich knapp.</p>

                    <div class="story-box">
                        <p><strong>Jetzt kommt der spannende Teil:</strong></p>
                        <p>Der Gastgeber (die amerikanische Notenbank "Fed") hat gerade angek√ºndigt: <em>"In den n√§chsten 20 Minuten kommt eine riesige neue Ladung Getr√§nke!"</em></p>
                        <p>Das sind 300 bis 500 MILLIARDEN Dollar die ins System gepumpt werden.</p>
                    </div>

                    <p style="margin-top: 20px;">Aber hier ist das Problem: Die schlauen G√§ste (wie Warren Buffett, einer der erfolgreichsten Investoren aller Zeiten) gehen schon zur T√ºr. Sie haben ihre Jacken an und verabschieden sich.</p>

                    <p><strong>Die gro√üe Frage ist:</strong> Gehst du mit den Schlauen zur T√ºr? Oder bleibst du noch f√ºr einen letzten Drink?</p>

                    <div class="warning-box">
                        <strong>Was das f√ºr dich bedeutet:</strong><br>
                        Du hast ein Zeitfenster von etwa 30 bis 90 Tagen f√ºr profitable Investments, bevor eine gr√∂√üere Korrektur kommt. Warren Buffett hat 382 Milliarden Dollar in Cash - er wartet bereits auf g√ºnstigere Preise.
                    </div>
                </div>

                <div class="hero-cta-container">
                    <p>Bereit loszulegen?</p>
                    <button class="hero-cta" id="heroCtaBtn">
                        Zeig mir die Investment-M√∂glichkeiten
                    </button>
                </div>
            </section>

            <!-- 4-Column Workspace -->
            <div class="workspace" id="workspace">
                <!-- Column 2: Area Synthesis -->
                <div class="area-synthesis" id="areaSynthesis">
                    <!-- Dynamic content -->
                </div>

                <!-- Column 3: Cluster List -->
                <div class="cluster-list" id="clusterList">
                    <!-- Dynamic content -->
                </div>

                <!-- Column 4: Chat Area -->
                <div class="chat-area" id="chatArea">
                    <div class="chat-tabs" id="chatTabs">
                        <div class="chat-placeholder">
                            W√§hle einen Cluster aus der Liste
                        </div>
                    </div>
                    <div id="chatContainers">
                        <!-- Dynamic chat containers -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ============================================
        // DATA LOADING FROM retail_analysis.json
        // ============================================

        let retailAnalysis = null;
        let areaData = {};
        let clusterData = {};

        // State management
        let currentArea = null;
        let currentCluster = null;
        let chatSessions = {};
        let activeChatId = null;

        // Load data on startup
        async function loadRetailAnalysis() {
            const loadingOverlay = document.getElementById('loadingOverlay');

            try {
                // Fetch from data directory (relative path)
                const response = await fetch('../data/retail_analysis.json');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                retailAnalysis = await response.json();
                console.log('Retail Analysis loaded:', retailAnalysis);

                // Transform data for UI
                transformDataForUI();

                // Render sidebar
                renderAreaNavigation();

                // Hide loading
                loadingOverlay.classList.add('hidden');

            } catch (error) {
                console.error('Error loading retail analysis:', error);
                loadingOverlay.innerHTML = `
                    <div class="error-message">
                        <h3>Fehler beim Laden</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px;">Stelle sicher, dass ein lokaler Server lauft:<br>
                        <code>python3 -m http.server 8000</code></p>
                    </div>
                `;
            }
        }

        // Transform retail_analysis.json into UI-friendly format
        function transformDataForUI() {
            const content = retailAnalysis.content || {};
            const areas = content.areas || {};
            const clusters = content.clusters || {};

            // Build areaData from areas (NEW v3.0 structure with area synthesis)
            for (const [areaId, area] of Object.entries(areas)) {
                const synthesis = area.synthesis || {};

                // Build cluster list from top_cluster + related_clusters
                const clusterList = [];

                // Add top cluster first
                if (synthesis.top_cluster) {
                    clusterList.push({
                        id: synthesis.top_cluster.cluster_id,
                        icon: '‚≠ê',
                        title: synthesis.top_cluster.cluster_name,
                        themes: synthesis.top_cluster.why_important || '',
                        timeframe: '7-14 Tage',
                        urgency: synthesis.urgency || 'high',
                        isTop: true
                    });
                }

                // Add related clusters
                for (const rc of (area.related_clusters || [])) {
                    clusterList.push({
                        id: rc.cluster_id,
                        icon: 'üìä',
                        title: rc.cluster_name,
                        themes: rc.one_liner || '',
                        timeframe: '7-30 Tage',
                        urgency: 'medium'
                    });
                }

                areaData[areaId] = {
                    title: area.title || areaId,
                    subtitle: area.description || '',
                    // NEW v3.0 area synthesis format
                    synthesis: {
                        headline: synthesis.headline || '',
                        content: synthesis.content || '',
                        keyTakeaway: synthesis.key_takeaway || '',
                        urgency: synthesis.urgency || 'medium',
                        topCluster: synthesis.top_cluster || null
                    },
                    relatedClusters: area.related_clusters || [],
                    clusters: clusterList
                };
            }

            // Build clusterData from clusters
            for (const [clusterId, cluster] of Object.entries(clusters)) {
                clusterData[clusterId] = {
                    title: cluster.title || clusterId,
                    subtitle: cluster.subtitle || '',
                    initialMessage: cluster.initial_message || 'Cluster-Details werden geladen...',
                    prompts: cluster.prompts || [],
                    themes_included: cluster.themes_included || []
                };

                // Update cluster themes in areaData
                for (const areaId of Object.keys(areaData)) {
                    const clusterInArea = areaData[areaId].clusters.find(c => c.id === clusterId);
                    if (clusterInArea && cluster.themes_included) {
                        clusterInArea.themes = cluster.themes_included.slice(0, 3).join(', ');
                    }
                }
            }

            console.log('Transformed areaData:', areaData);
            console.log('Transformed clusterData:', clusterData);
        }

        // Render area navigation in sidebar
        function renderAreaNavigation() {
            const nav = document.getElementById('areaNav');

            // Home item
            let html = `
                <div class="area-item active" onclick="showHero()">
                    <span class="area-icon">üè†</span>
                    <div class="area-content">
                        <div class="area-title">Start hier!</div>
                        <div class="area-count">Einf√ºhrung</div>
                    </div>
                </div>
            `;

            // Synthesis item (Portfolio-√úberblick)
            html += `
                <div class="area-item" data-area="synthesis" onclick="showSynthesis()">
                    <span class="area-icon">üìä</span>
                    <div class="area-content">
                        <div class="area-title">Markt-Synthese</div>
                        <div class="area-count">Gesamt-√úberblick</div>
                    </div>
                </div>
            `;

            // Portfolio item
            html += `
                <div class="area-item" data-area="portfolio" onclick="showPortfolio()">
                    <span class="area-icon">üíº</span>
                    <div class="area-content">
                        <div class="area-title">Portfolio</div>
                        <div class="area-count">Allocation & Hedges</div>
                    </div>
                </div>
            `;

            // Separator
            html += `<div style="border-top: 1px solid #1a1a1a; margin: 12px 8px;"></div>`;

            // Area items from data (NEW v3.0 combined areas)
            const areaIcons = {
                macro: 'üí∞',        // Combined: Monetary + Fiscal
                sectors: 'üè¢',      // Sectors & Themes
                geopolitics: 'üåê',  // Geopolitics & Trade
                // Legacy fallbacks
                monetary: 'üíµ',
                fiscal: 'üèõÔ∏è',
                risks: '‚ö†Ô∏è'
            };

            for (const [areaId, area] of Object.entries(areaData)) {
                const clusterCount = area.clusters?.length || 0;
                const icon = areaIcons[areaId] || 'üìä';

                html += `
                    <div class="area-item" data-area="${areaId}" onclick="selectArea('${areaId}')">
                        <span class="area-icon">${icon}</span>
                        <div class="area-content">
                            <div class="area-title">${area.title}</div>
                            <div class="area-count">${clusterCount} Cluster</div>
                        </div>
                    </div>
                `;
            }

            nav.innerHTML = html;

            // Setup hero CTA button - direkt zur Synthese f√ºr Lesefluss
            const heroBtn = document.getElementById('heroCtaBtn');
            if (heroBtn) {
                heroBtn.onclick = () => showSynthesis();
            }
        }

        // Show hero section
        // Store original hero content
        const originalHeroContent = `
            <h1 class="hero-title">Willkommen bei K-State</h1>

            <div class="hero-card">
                <h2>Das Wichtigste zuerst</h2>
                <p>Stell dir vor, du bist auf einer riesigen Party die schon seit 3 Jahren l√§uft.</p>
                <p>Die Musik spielt laut (das ist der AI-Hype - jeder redet √ºber k√ºnstliche Intelligenz). Die Stimmung ist super. Aber die Getr√§nke waren die letzten 18 Monate ziemlich knapp.</p>

                <div class="story-box">
                    <p><strong>Jetzt kommt der spannende Teil:</strong></p>
                    <p>Der Gastgeber (die amerikanische Notenbank "Fed") hat gerade angek√ºndigt: <em>"In den n√§chsten 20 Minuten kommt eine riesige neue Ladung Getr√§nke!"</em></p>
                    <p>Das sind 300 bis 500 MILLIARDEN Dollar die ins System gepumpt werden.</p>
                </div>

                <p style="margin-top: 20px;">Aber hier ist das Problem: Die schlauen G√§ste (wie Warren Buffett, einer der erfolgreichsten Investoren aller Zeiten) gehen schon zur T√ºr. Sie haben ihre Jacken an und verabschieden sich.</p>

                <p><strong>Die gro√üe Frage ist:</strong> Gehst du mit den Schlauen zur T√ºr? Oder bleibst du noch f√ºr einen letzten Drink?</p>

                <div class="warning-box">
                    <strong>Was das f√ºr dich bedeutet:</strong><br>
                    Du hast ein Zeitfenster von etwa 30 bis 90 Tagen f√ºr profitable Investments, bevor eine gr√∂√üere Korrektur kommt. Warren Buffett hat 382 Milliarden Dollar in Cash - er wartet bereits auf g√ºnstigere Preise.
                </div>
            </div>

            <div class="hero-cta-container">
                <p>Bereit loszulegen?</p>
                <button class="hero-cta" id="heroCtaBtn" onclick="showSynthesis()">
                    Zeig mir die Investment-M√∂glichkeiten
                </button>
            </div>
        `;

        function showHero() {
            // Restore original hero content
            document.getElementById('heroSection').innerHTML = originalHeroContent;
            document.getElementById('heroSection').classList.remove('hidden');
            document.getElementById('workspace').classList.remove('visible');

            document.querySelectorAll('.area-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector('.area-item').classList.add('active');

            currentArea = null;
            currentCluster = null;
        }

        // Show Synthesis (Markt-Synthese)
        function showSynthesis() {
            const synthesis = retailAnalysis?.content?.synthesis;
            if (!synthesis) {
                alert('Keine Synthese verf√ºgbar');
                return;
            }

            // Update sidebar
            document.querySelectorAll('.area-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.area-item[data-area="synthesis"]').classList.add('active');

            // Show hero section (full-width), hide workspace
            document.getElementById('heroSection').classList.remove('hidden');
            document.getElementById('workspace').classList.remove('visible');

            // Render synthesis in hero section (full-width layout)
            const heroSection = document.getElementById('heroSection');
            heroSection.innerHTML = `
                <h1 class="hero-title">üìä ${synthesis.title || 'Markt-Synthese'}</h1>

                <div class="hero-card">
                    <h2>üåç Das gro√üe Bild</h2>
                    <p>${synthesis.big_picture || ''}</p>
                </div>

                <div class="hero-card">
                    <h2>üí° Key Insights</h2>
                    <p>${synthesis.key_insights || ''}</p>
                </div>

                <div class="hero-card">
                    <h2>‚öñÔ∏è Chancen vs. Risiken</h2>
                    <p>${synthesis.risk_reward_balance || ''}</p>
                </div>

                ${synthesis.devils_advocate ? `
                <div class="hero-card" style="border-left: 3px solid #ff4444;">
                    <h2 style="color: #ff4444;">üòà Devil's Advocate</h2>
                    <p>${synthesis.devils_advocate.main_risks || ''}</p>
                    <div class="warning-box">
                        <p><strong>Ehrliche Kritik:</strong> ${synthesis.devils_advocate.honest_critique || ''}</p>
                    </div>
                </div>
                ` : ''}

                <div class="hero-card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);">
                    <h2>üéØ Fazit</h2>
                    <p><strong>Gesamt-Haltung:</strong> ${synthesis.overall_stance || 'N/A'}</p>
                    <p><strong>Konfidenz:</strong> ${synthesis.confidence || 'N/A'}%</p>
                </div>

                <div class="hero-cta-container">
                    <p>Bereit f√ºr die Details?</p>
                    <button class="hero-cta" onclick="showPortfolio()">üìà Portfolio anzeigen</button>
                </div>
            `;
        }

        // Show Portfolio
        function showPortfolio() {
            const portfolio = retailAnalysis?.content?.portfolio;
            const summary = retailAnalysis?.content?.retail_summary;
            if (!portfolio) {
                alert('Kein Portfolio verf√ºgbar');
                return;
            }

            // Update sidebar
            document.querySelectorAll('.area-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.area-item[data-area="portfolio"]').classList.add('active');

            // Show hero section (full-width), hide workspace
            document.getElementById('heroSection').classList.remove('hidden');
            document.getElementById('workspace').classList.remove('visible');

            const alloc = portfolio.asset_allocation || {};
            const sectors = portfolio.sector_allocation || [];

            // Render portfolio in hero section (full-width layout)
            const heroSection = document.getElementById('heroSection');
            heroSection.innerHTML = `
                <h1 class="hero-title">üìà Portfolio Allocation</h1>

                ${summary?.one_liner ? `
                <div class="hero-card" style="text-align: center;">
                    <p style="font-size: 18px;"><strong>${summary.one_liner}</strong></p>
                </div>
                ` : ''}

                <div class="hero-card">
                    <h2>üìä Asset Allocation</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                            <p style="font-size: 24px; font-weight: bold; color: #667eea;">${alloc.equities?.percent || 0}%</p>
                            <p><strong>Aktien</strong></p>
                            <p style="font-size: 12px; opacity: 0.8;">${alloc.equities?.rationale || ''}</p>
                        </div>
                        <div style="padding: 15px; background: rgba(74, 158, 255, 0.1); border-radius: 8px;">
                            <p style="font-size: 24px; font-weight: bold; color: #4a9eff;">${alloc.bonds?.percent || 0}%</p>
                            <p><strong>Anleihen</strong></p>
                            <p style="font-size: 12px; opacity: 0.8;">${alloc.bonds?.rationale || ''}</p>
                        </div>
                        <div style="padding: 15px; background: rgba(255, 215, 68, 0.1); border-radius: 8px;">
                            <p style="font-size: 24px; font-weight: bold; color: #ffd744;">${alloc.commodities?.percent || 0}%</p>
                            <p><strong>Rohstoffe</strong></p>
                            <p style="font-size: 12px; opacity: 0.8;">${alloc.commodities?.rationale || ''}</p>
                        </div>
                        <div style="padding: 15px; background: rgba(150, 150, 150, 0.1); border-radius: 8px;">
                            <p style="font-size: 24px; font-weight: bold; color: #999;">${alloc.cash?.percent || 0}%</p>
                            <p><strong>Cash</strong></p>
                            <p style="font-size: 12px; opacity: 0.8;">${alloc.cash?.rationale || ''}</p>
                        </div>
                        <div style="padding: 15px; background: rgba(255, 68, 68, 0.1); border-radius: 8px;">
                            <p style="font-size: 24px; font-weight: bold; color: #ff4444;">${alloc.hedges?.percent || 0}%</p>
                            <p><strong>Hedges</strong></p>
                            <p style="font-size: 12px; opacity: 0.8;">${alloc.hedges?.rationale || ''}</p>
                        </div>
                    </div>
                </div>

                ${sectors.length > 0 ? `
                <div class="hero-card">
                    <h2>üè≠ Sektor-Allokation</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px;">
                        ${sectors.map(sector => `
                            <div style="padding: 15px; background: #0f0f0f; border: 1px solid #1a1a1a; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="font-weight: 600;">${sector.sector}</span>
                                    <span style="color: #667eea; font-weight: bold;">${sector.percent}%</span>
                                </div>
                                <p style="font-size: 12px; color: #999;">${sector.rationale || ''}</p>
                                ${sector.positions ? `<p style="font-size: 11px; color: #666; margin-top: 8px;">Positionen: ${sector.positions.join(', ')}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${summary?.top_3_actions ? `
                <div class="hero-card" style="border-left: 3px solid #667eea;">
                    <h2 style="color: #667eea;">üéØ Top 3 Actions</h2>
                    ${summary.top_3_actions.map((action, i) => `
                        <div style="padding: 12px; margin: 10px 0; background: rgba(102, 126, 234, 0.05); border-radius: 6px;">
                            <strong>${i+1}.</strong> ${action}
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                <div class="hero-cta-container">
                    <p>Tiefere Analyse der Bereiche?</p>
                    <button class="hero-cta" onclick="selectArea('macro')">üèõÔ∏è Makro & Geldpolitik</button>
                </div>
            `;
        }

        // Show sector detail in chat area
        function showSectorDetail(clusterId) {
            const portfolio = retailAnalysis?.content?.portfolio;
            const sector = portfolio?.sector_allocation?.find(s => s.cluster_id === clusterId);
            if (!sector) return;

            // Create a simple detail view
            const chatContainer = document.getElementById('chatContainers');
            chatContainer.innerHTML = `
                <div class="chat-container active">
                    <div class="chat-header">
                        <h3>${sector.sector}</h3>
                        <p>${sector.percent}% Portfolio-Gewichtung</p>
                    </div>
                    <div class="chat-messages" style="padding: 30px;">
                        <div class="message">
                            <div class="message-content">
                                <h4>Warum diese Gewichtung?</h4>
                                <p>${sector.rationale_why_this_percent || ''}</p>

                                <h4 style="margin-top: 20px;">Positionen</h4>
                                ${(sector.positions || []).map(p => `
                                    <p><strong>${p.ticker}</strong> (${p.percent}%): ${p.rationale}</p>
                                `).join('<br>')}

                                <h4 style="margin-top: 20px;">Entry Timing</h4>
                                <p>${sector.entry_timing || 'N/A'}</p>

                                <h4 style="margin-top: 20px;">Exit Triggers</h4>
                                <ul>
                                    ${(sector.exit_triggers || []).map(t => `<li>${t}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('chatTabs').innerHTML = `
                <div class="chat-tab active">${sector.sector}</div>
            `;
        }

        // Select area
        function selectArea(areaId) {
            const area = areaData[areaId];
            if (!area) {
                console.error('Area not found:', areaId);
                return;
            }

            currentArea = areaId;
            currentCluster = null;

            // Update sidebar
            document.querySelectorAll('.area-item').forEach(item => {
                item.classList.remove('active');
            });
            const targetItem = document.querySelector(`.area-item[data-area="${areaId}"]`);
            if (targetItem) {
                targetItem.classList.add('active');
            }

            // Hide hero, show workspace
            document.getElementById('heroSection').classList.add('hidden');
            document.getElementById('workspace').classList.add('visible');

            // Render columns
            renderAreaSynthesis(area);
            renderClusterList(area);
            resetChatArea();
        }

        // Render Column 2: Area Synthesis (NEW v3.0 retail-style format)
        function renderAreaSynthesis(area) {
            const container = document.getElementById('areaSynthesis');
            const synthesis = area.synthesis;

            // Urgency badge color
            const urgencyColors = {
                ultra: { bg: 'rgba(255, 68, 68, 0.2)', color: '#ff4444', label: 'üî¥ Ultra-Urgent' },
                high: { bg: 'rgba(255, 153, 68, 0.2)', color: '#ff9944', label: 'üü† Wichtig' },
                medium: { bg: 'rgba(255, 215, 68, 0.2)', color: '#ffd744', label: 'üü° Monitor' },
                low: { bg: 'rgba(102, 126, 234, 0.2)', color: '#667eea', label: 'üü¢ Langfristig' }
            };
            const urgency = urgencyColors[synthesis.urgency] || urgencyColors.medium;

            // Top cluster highlight
            let topClusterHtml = '';
            if (synthesis.topCluster) {
                topClusterHtml = `
                    <div class="synthesis-section" style="background: rgba(102, 126, 234, 0.1); border-left: 3px solid #667eea;">
                        <div class="synthesis-section-title" style="color: #667eea;">üí° Wichtigster Cluster</div>
                        <div class="synthesis-content">
                            <p><strong>${synthesis.topCluster.cluster_name}</strong></p>
                            <p style="font-size: 13px; opacity: 0.85;">${synthesis.topCluster.why_important}</p>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                    <span class="cluster-urgency" style="background: ${urgency.bg}; color: ${urgency.color}; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500;">${urgency.label}</span>
                </div>
                <div class="synthesis-title">${synthesis.headline || area.title}</div>
                <div class="synthesis-content">
                    ${synthesis.content || '<p>Keine Synthese verf√ºgbar.</p>'}
                </div>

                ${topClusterHtml}

                <div class="synthesis-section" style="background: rgba(74, 158, 255, 0.1); border-left: 3px solid #4a9eff;">
                    <div class="synthesis-section-title" style="color: #4a9eff;">üéØ Key Takeaway</div>
                    <div class="synthesis-content">
                        <p style="font-weight: 500;">${synthesis.keyTakeaway || 'Keine Zusammenfassung verf√ºgbar.'}</p>
                    </div>
                </div>
            `;
        }

        // Render Column 3: Cluster List (NEW v3.0 with top cluster highlight)
        function renderClusterList(area) {
            const container = document.getElementById('clusterList');

            let clustersHtml = (area.clusters || []).map(cluster => {
                const isTopCluster = cluster.isTop;
                const borderStyle = isTopCluster ? 'border-left: 3px solid #667eea;' : '';
                const bgStyle = isTopCluster ? 'background: rgba(102, 126, 234, 0.1);' : '';

                return `
                <div class="cluster-item" style="${borderStyle} ${bgStyle}" onclick="selectCluster('${cluster.id}')">
                    <div class="cluster-header">
                        <span class="cluster-icon">${cluster.icon}</span>
                        <span class="cluster-title">${cluster.title}</span>
                    </div>
                    ${cluster.themes ? `<div class="cluster-themes">${cluster.themes}</div>` : ''}
                    <div class="cluster-meta">
                        <span class="cluster-timeframe">${cluster.timeframe}</span>
                        <span class="cluster-urgency urgency-${cluster.urgency}">
                            ${cluster.urgency === 'ultra' ? 'üî¥ Ultra-Urgent' :
                              cluster.urgency === 'high' ? 'üü† Wichtig' :
                              cluster.urgency === 'medium' ? 'üü° Monitor' : 'üü¢ Langfristig'}
                        </span>
                    </div>
                </div>
            `}).join('');

            container.innerHTML = `
                <div class="cluster-list-header">
                    <div class="cluster-list-title">Investment-Cluster</div>
                </div>
                ${clustersHtml || '<p style="color: #666; padding: 20px;">Keine Cluster verf√ºgbar</p>'}
            `;
        }

        // Reset chat area
        function resetChatArea() {
            document.getElementById('chatTabs').innerHTML = `
                <div class="chat-placeholder">
                    W√§hle einen Cluster aus der Liste
                </div>
            `;
            document.getElementById('chatContainers').innerHTML = '';
        }

        // Select cluster
        function selectCluster(clusterId) {
            const data = clusterData[clusterId];
            if (!data) {
                console.warn('Cluster details not available:', clusterId);
                alert('Cluster-Details noch nicht verf√ºgbar. Bitte generiere zuerst den Content.');
                return;
            }

            currentCluster = clusterId;

            // Update cluster list active state
            document.querySelectorAll('.cluster-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.cluster-item').classList.add('active');

            // Check if cluster already has chats
            if (!chatSessions[clusterId]) {
                chatSessions[clusterId] = [];
            }

            // If first time, create initial chat with overview
            if (chatSessions[clusterId].length === 0) {
                createNewChat(clusterId, true);
            } else {
                renderChatTabs(clusterId);
                activeChatId = chatSessions[clusterId][chatSessions[clusterId].length - 1].id;
                showChat(activeChatId);
            }
        }

        // Create new chat
        function createNewChat(clusterId, isFirstVisit = false) {
            const data = clusterData[clusterId];
            if (!data) return;

            const chatId = `${clusterId}-${Date.now()}`;

            const newChat = {
                id: chatId,
                clusterId: clusterId,
                messages: [],
                isFirstVisit: isFirstVisit
            };

            // Add initial message
            if (isFirstVisit) {
                newChat.messages.push({
                    sender: 'claude',
                    content: data.initialMessage,
                    prompts: data.prompts
                });
            } else {
                newChat.messages.push({
                    sender: 'claude',
                    content: `Hey! Du bist im <strong>"${data.title}"</strong> Cluster.<br><br>Was m√∂chtest du genau wissen?<br><br>Ich kann dir helfen mit:<br>‚Ä¢ Warum diese Themes zusammen wichtig sind<br>‚Ä¢ Konkrete Investment-Schritte<br>‚Ä¢ Risk-Management<br>‚Ä¢ Historische Vergleiche<br>‚Ä¢ Was-wenn-Szenarien<br><br>Stell mir einfach deine Frage!`,
                    prompts: data.prompts
                });
            }

            chatSessions[clusterId].push(newChat);
            activeChatId = chatId;

            renderChatTabs(clusterId);
            renderChat(chatId);
            showChat(chatId);
        }

        // Render chat tabs
        function renderChatTabs(clusterId) {
            const tabsContainer = document.getElementById('chatTabs');
            tabsContainer.innerHTML = '';

            const chats = chatSessions[clusterId] || [];
            chats.forEach((chat, index) => {
                const tab = document.createElement('div');
                tab.className = 'chat-tab' + (chat.id === activeChatId ? ' active' : '');
                tab.onclick = () => showChat(chat.id);

                const label = chat.isFirstVisit ? '√úbersicht' : `Chat ${index + 1}`;
                tab.innerHTML = `
                    <span>${label}</span>
                    ${chats.length > 1 ? `<span class="chat-tab-close" onclick="closeChat('${chat.id}', event)">√ó</span>` : ''}
                `;

                tabsContainer.appendChild(tab);
            });

            // Add new chat button
            const newBtn = document.createElement('div');
            newBtn.className = 'new-chat-btn';
            newBtn.innerHTML = '<span>+</span><span>Neuer Chat</span>';
            newBtn.onclick = () => createNewChat(clusterId, false);
            tabsContainer.appendChild(newBtn);
        }

        // Render chat
        function renderChat(chatId) {
            const chat = Object.values(chatSessions).flat().find(c => c.id === chatId);
            if (!chat) return;

            const data = clusterData[chat.clusterId];
            const container = document.getElementById('chatContainers');

            let chatDiv = document.getElementById(`chat-${chatId}`);
            if (chatDiv) return;

            chatDiv = document.createElement('div');
            chatDiv.id = `chat-${chatId}`;
            chatDiv.className = 'chat-container';

            chatDiv.innerHTML = `
                <div class="chat-header">
                    <h3>${data.title}</h3>
                    <p>${data.subtitle}</p>
                </div>
                <div class="chat-messages" id="messages-${chatId}">
                    ${chat.messages.map(msg => renderMessage(msg)).join('')}
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-wrapper">
                        <textarea
                            class="chat-input"
                            id="input-${chatId}"
                            placeholder="Stell deine Frage..."
                            rows="1"
                        ></textarea>
                        <button class="send-btn" onclick="sendMessage('${chatId}')">Senden</button>
                    </div>
                </div>
            `;

            container.appendChild(chatDiv);

            const input = document.getElementById(`input-${chatId}`);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(chatId);
                }
            });
        }

        // Render message
        function renderMessage(msg) {
            const isUser = msg.sender === 'user';
            const avatar = isUser ? 'üë§' : 'ü§ñ';
            const avatarClass = isUser ? 'avatar-user' : 'avatar-claude';

            let promptsHtml = '';
            if (msg.prompts && msg.prompts.length > 0) {
                promptsHtml = `
                    <div class="quick-actions">
                        ${msg.prompts.map(p => `
                            <div class="quick-action-btn" onclick="sendPrompt('${p.replace(/'/g, "\\'").replace(/üí¨/g, '').trim()}')">${p}</div>
                        `).join('')}
                    </div>
                `;
            }

            return `
                <div class="message">
                    <div class="message-header">
                        <div class="message-avatar ${avatarClass}">${avatar}</div>
                        <span class="message-sender">${isUser ? 'Du' : 'Claude'}</span>
                    </div>
                    <div class="message-content">
                        ${formatContent(msg.content)}
                        ${promptsHtml}
                    </div>
                </div>
            `;
        }

        // Format content
        function formatContent(content) {
            if (!content) return '';
            return content
                .replace(/<strong>(.*?)<\/strong>/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^(.*)$/, '<p>$1</p>');
        }

        // Show chat
        function showChat(chatId) {
            activeChatId = chatId;

            document.querySelectorAll('.chat-container').forEach(c => {
                c.classList.remove('active');
            });

            document.querySelectorAll('.chat-tab').forEach(t => {
                t.classList.remove('active');
            });

            const chatDiv = document.getElementById(`chat-${chatId}`);
            if (chatDiv) {
                chatDiv.classList.add('active');
            }

            const chat = Object.values(chatSessions).flat().find(c => c.id === chatId);
            if (chat) {
                const chats = chatSessions[chat.clusterId];
                const index = chats.findIndex(c => c.id === chatId);
                const tabs = document.querySelectorAll('.chat-tab');
                if (tabs[index]) {
                    tabs[index].classList.add('active');
                }
            }

            setTimeout(() => {
                const messagesDiv = document.getElementById(`messages-${chatId}`);
                if (messagesDiv) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            }, 100);
        }

        // Close chat
        function closeChat(chatId, event) {
            event.stopPropagation();

            const chat = Object.values(chatSessions).flat().find(c => c.id === chatId);
            if (!chat) return;

            const clusterChats = chatSessions[chat.clusterId];
            const index = clusterChats.findIndex(c => c.id === chatId);

            if (index > -1) {
                clusterChats.splice(index, 1);
            }

            const chatDiv = document.getElementById(`chat-${chatId}`);
            if (chatDiv) chatDiv.remove();

            if (clusterChats.length === 0) {
                resetChatArea();
                return;
            }

            activeChatId = clusterChats[Math.max(0, index - 1)].id;
            renderChatTabs(chat.clusterId);
            showChat(activeChatId);
        }

        // Send message
        function sendMessage(chatId) {
            const input = document.getElementById(`input-${chatId}`);
            const message = input.value.trim();

            if (!message) return;

            const chat = Object.values(chatSessions).flat().find(c => c.id === chatId);
            if (!chat) return;

            chat.messages.push({
                sender: 'user',
                content: message
            });

            input.value = '';
            updateChatMessages(chatId);

            // Mock response (in real MVP, this would call an API)
            setTimeout(() => {
                const response = generateMockResponse(message, chat.clusterId);
                chat.messages.push({
                    sender: 'claude',
                    content: response.content,
                    prompts: response.prompts
                });
                updateChatMessages(chatId);
            }, 1000);
        }

        // Send prompt
        function sendPrompt(prompt) {
            const input = document.getElementById(`input-${activeChatId}`);
            input.value = prompt;
            sendMessage(activeChatId);
        }

        // Update chat messages
        function updateChatMessages(chatId) {
            const chat = Object.values(chatSessions).flat().find(c => c.id === chatId);
            if (!chat) return;

            const messagesDiv = document.getElementById(`messages-${chatId}`);
            if (!messagesDiv) return;

            messagesDiv.innerHTML = chat.messages.map(msg => renderMessage(msg)).join('');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Generate mock response
        function generateMockResponse(message, clusterId) {
            const data = clusterData[clusterId];

            return {
                content: `Das ist eine gute Frage! Im Kontext von <strong>${data?.title || clusterId}</strong>...<br><br>

Im echten MVP w√ºrde hier eine API-Antwort von Claude kommen, die auf den K-State Daten basiert.<br><br>

<strong>F√ºr jetzt ist das ein Mockup.</strong> Die echte Implementierung w√ºrde:<br>
‚Ä¢ Die Frage an einen Backend-Server senden<br>
‚Ä¢ Der Server w√ºrde Claude mit K-State Context aufrufen<br>
‚Ä¢ Die Antwort w√ºrde hier angezeigt werden<br><br>

Was m√∂chtest du noch wissen?`,
                prompts: data?.prompts?.slice(0, 3) || ['Erkl√§re mehr Details', 'Was sind die Risiken?']
            };
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadRetailAnalysis);
    </script>
</body>
</html>
